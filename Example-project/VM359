
  import { renderFeedbackUI } from "https://vf-cloudflare-pages.pages.dev/feedback.js";
  window.addEventListener(
    "message",
    (event) => {
      if (event.data && typeof event.data === "string") {
        try {
          const data = JSON.parse(event.data);
          if (data.type == "voiceflow:interact") {
            const actionPayload = data.payload?.action?.payload;

            if (
              !actionPayload?.feedback &&
              actionPayload?.actions?.[0]?.type != "open_url"
            ) {
              setTimeout(() => {
                const chatElement = document.querySelector("#voiceflow-chat");
                const messages =
                  chatElement?.shadowRoot?.querySelectorAll(".vfrc-message");

                if (messages?.length > 1) {
                  renderFeedbackUI(messages[messages.length - 1]);
                }
              }, 250);
            }
          } else if (data.type == "voiceflow:open") {
            localStorage.setItem(
              "crocsltProactiveMessageShown",
              Date.now().toString()
            );

            window.voiceflow.chat.proactive.clear();
          }
        } catch (error) {
          console.error("Error processing Voiceflow event:", error);
        }
      }
    },
    false
  );

  (function (d, t) {
    var v = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    v.onload = function () {
      window.voiceflow.chat
        .load({
          verify: { projectID: "685c188185cda19294fa2ff9" },
          url: "https://general-runtime.voiceflow.com",
          versionID: "production",
          voice: {
            url: "https://runtime-api.voiceflow.com",
          },
          assistant: {
            persistence: "sessionStorage",
            stylesheet: "https://vf-cloudflare-pages.pages.dev/crocs-lt.css",
          },
        })
        .then(() => {
          const elementToClick = document.getElementById("open-chatbot");

          if (elementToClick) {
            elementToClick.addEventListener("click", function (event) {
              const isChatbotOpen = sessionStorage.getItem("isChatbotOpen");
              window.voiceflow.chat.open();

              if (isChatbotOpen) {
                return;
              }

              setTimeout(() => {
                sessionStorage.setItem("isChatbotOpen", true);
                window.voiceflow.chat.interact({
                  type: "intent",
                  payload: {
                    intent: { name: "open_chatbot" },
                    entities: [],
                  },
                });
              }, 2000);
            });
          }
        })
        .then(() => {
          window.voiceflow.chat.proactive.clear();
          const shownData = localStorage.getItem(
            "crocsltProactiveMessageShown"
          );

          if (shownData) {
            const shownTimestamp = Number(shownData);
            const ONE_DAY = 1 * 24 * 60 * 60 * 1000;

            if (shownTimestamp && Date.now() - shownTimestamp < ONE_DAY) {
              return;
            }
          }

          const proactiveMessageTiming = sessionStorage.getItem(
            "proactiveMessageTime"
          );

          const popupInSeconds = proactiveMessageTiming ?? 5000;

          setTimeout(() => {
            sessionStorage.setItem("proactiveMessageTime", 350);
            window.voiceflow.chat.proactive.push({
              type: "text",
              payload: {
                message: `Galiu padėti - parašykite!`,
              },
            });

            setTimeout(() => {
              const proactiveButton = document
                .querySelector("#voiceflow-chat")
                .shadowRoot.querySelector(".vfrc-proactive .vfrc-button");

              if (proactiveButton) {
                proactiveButton.addEventListener("click", () => {
                  localStorage.setItem(
                    "crocsltProactiveMessageShown",
                    Date.now().toString()
                  );
                });
              }
            }, 350);
          }, popupInSeconds);
        });
    };
    v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
    v.type = "text/javascript";
    s.parentNode.insertBefore(v, s);
  })(document, "script");
