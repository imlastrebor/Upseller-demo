
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Voiceflow Chat Landing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="Welcome visitors with an accessible Voiceflow chat experience on a full-screen background."
    />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Voiceflow Chat Landing" />
    <meta
      property="og:description"
      content="Invite visitors to chat with Voiceflow on a performant, accessible landing page."
    />
    <meta property="og:image" content="assets/popup_bg.png" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Voiceflow Chat Landing" />
    <meta
      name="twitter:description"
      content="Invite visitors to chat with Voiceflow on a performant, accessible landing page."
    />
    <meta name="twitter:image" content="assets/popup_bg.png" />

    <link rel="icon" href="assets/favicon.ico" />
    <link rel="preload" href="assets/popup_bg.png" as="image" />
    <link rel="stylesheet" href="styles/main.css" />
  </head>
  <body>
    <a class="skip-link" href="#main-content">Skip to chat</a>

    <header class="site-header" role="banner">
      <h1 class="visually-hidden">Voiceflow Chat Landing</h1>
    </header>

    <main id="main-content" class="site-main" role="main" aria-label="Chat area">
      <div class="chat-shell" role="region" aria-label="Voiceflow chat">
        <p class="chat-shell__message">
          Tap the Voiceflow chat bubble in the corner to start the conversation.
        </p>
      </div>
      <a
        class="floating-link"
        href="https://example.com"
        target="_blank"
        rel="noreferrer"
        aria-label="Learn more about this assistant (opens in a new tab)"
      >
        <span class="floating-link__text">Company site</span>
        <img
          src="assets/arrow.svg"
          alt=""
          aria-hidden="true"
          class="floating-link__icon"
        />
      </a>
    </main>

    <footer class="site-footer" role="contentinfo">
      <p class="visually-hidden">Footer</p>
    </footer>



<script>

console.log('Config File: default.js - default client config file loaded');


  (function(d, t) {
      var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
      v.onload = function() {
        window.voiceflow.chat.load({
          verify: { projectID: '68f9dca7b9abe8c36ec96e77' },
          url: 'https://general-runtime.voiceflow.com',
          versionID: 'production',
          assistant: {
            extensions: [] // your extension's name goes here
          },
          voice: {
            url: "https://runtime-api.voiceflow.com"
          }
        });
      }
      v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs"; v.type = "text/javascript"; s.parentNode.insertBefore(v, s);
  })(document, 'script');



//run other scripts here

const UPS_ANALYTICS_URL = 'https://upseller-analytics.vercel.app/api/events';
const UPS_EVENT_TOKEN = 'test_sandbox_write_token_123';
const VF_TEST_PROJECT_ID = '68f9dca7b9abe8c36ec96e77';
const VF_WIDGET_HOST_SELECTOR = '#voiceflow-chat';
const UPS_SESSION_ID =
  localStorage.getItem('ups_session_id') ||
  (() => {
    const id = crypto.randomUUID();
    localStorage.setItem('ups_session_id', id);
    return id;
  })();

async function sendWidgetEvent(eventName, props = {}) {
  try {
    console.log('[Upseller Analytics] Sending event:', eventName, props);
    await fetch(UPS_ANALYTICS_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${UPS_EVENT_TOKEN}`,
      },
      body: JSON.stringify({
        events: [
          {
            event_id: crypto.randomUUID(),
            event_name: eventName,
            session_id: UPS_SESSION_ID,
            occurred_at: new Date().toISOString(),
            project_id: VF_TEST_PROJECT_ID,
            properties: { page: window.location.pathname, ...props },
          },
        ],
      }),
    });
  } catch (error) {
    console.error('[Upseller Analytics] Failed to send', eventName, error);
  }
}

function trackWidgetSeenOnce() {
  if (window.__upsellerWidgetSeen) return;
  console.log('[Upseller Analytics] Widget seen detected');
  window.__upsellerWidgetSeen = true;
  sendWidgetEvent('widget_seen', { page: window.location.pathname });
}

function findVoiceflowWidget() {
  const host = document.querySelector(VF_WIDGET_HOST_SELECTOR);
  if (!host) {
    console.log('[Upseller Analytics] Widget host not found yet');
    return null;
  }

  if (host.shadowRoot) {
    return host.shadowRoot.querySelector('.vfrc-widget');
  }

  return host;
}

window.addEventListener('load', () => {
  const initialWidget = findVoiceflowWidget();
  if (initialWidget) {
    console.log('[Upseller Analytics] Widget already present on load');
    trackWidgetSeenOnce();
    return;
  }

  const observer = new MutationObserver(() => {
    const widgetEl = findVoiceflowWidget();

    if (widgetEl) {
      console.log('[Upseller Analytics] Widget detected via MutationObserver');
      trackWidgetSeenOnce();
      observer.disconnect();
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });
});


</script>

    <script type="module">
      // Conversation-level feedback below the composer.
      const FEEDBACK_CONTAINER_ID = "vf-convo-feedback";
      const STYLES_ID = "vf-convo-feedback-styles";
      const CTA_TEXT = "Miten onnistuimme?";
      const PANEL_TITLE = "Arvioi onnistumisemme";
      const COMMENT_LABEL = "Kirjoita palaute";
      const INJECTION_DELAY_MS = 250;

      const getChatShadowRoot = () => document.querySelector("#voiceflow-chat")?.shadowRoot;

      const ensureStyles = (shadow) => {
        if (!shadow || shadow.getElementById(STYLES_ID)) return;
        const style = document.createElement("style");
        style.id = STYLES_ID;
        style.textContent = `
          #${FEEDBACK_CONTAINER_ID} {
            margin-top: 4px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-family: inherit;
            color: inherit;
            position: relative;
            width: 100%;
          }
          .vfrc-footer__content {
            position: relative;
          }
          .vf-convo-cta {
            align-self: flex-start;
            border: none;
            background: transparent;
            color: #0f2d32;
            padding: 6px 0;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-decoration: underline;
            text-underline-offset: 3px;
            transition: color 0.12s ease, opacity 0.12s ease;
          }
          .vf-convo-cta:hover {
            color: #0b2930;
            opacity: 0.9;
          }
          #${FEEDBACK_CONTAINER_ID} .vf-convo-panel {
            position: absolute;
            right: 0;
            bottom: 42px;
            left: 0;
            width: 100%;
            max-width: 100%;
            border: 1px solid rgba(0,0,0,0.1);
            background: #ffffff;
            color: #0f2d32;
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.16);
            z-index: 120;
            opacity: 0;
            transform: translateY(12px);
            pointer-events: none;
            transition: opacity 160ms ease, transform 160ms ease;
          }
          #${FEEDBACK_CONTAINER_ID}.open .vf-convo-panel {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
          }
          #${FEEDBACK_CONTAINER_ID} .vf-convo-header {
            font-weight: 600;
            font-size: 14px;
            margin: 0 0 10px 0;
            font-size: 1rem;
          }
          #${FEEDBACK_CONTAINER_ID} .vf-convo-ratings {
            display: grid;
            grid-template-columns: repeat(5, minmax(32px, 1fr));
            gap: 8px;
            margin-bottom: 12px;
          }
          #${FEEDBACK_CONTAINER_ID} .vf-convo-rating-btn {
            border: 1px solid rgba(0,0,0,0.12);
            background: #f6fbff;
            color: #0f2d32;
            border-radius: 10px;
            padding: 10px 0;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease, background 0.1s ease;
          }
          #${FEEDBACK_CONTAINER_ID} .vf-convo-rating-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.08);
          }
          #${FEEDBACK_CONTAINER_ID} .vf-convo-rating-btn.selected {
            background: #e2f4ff;
            border-color: rgba(72,198,234,0.6);
            box-shadow: 0 8px 18px rgba(72,198,234,0.25);
          }
          #${FEEDBACK_CONTAINER_ID} label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #0b2930;
            font-size: 14px;
          }
          #${FEEDBACK_CONTAINER_ID} textarea {
            width: 100%;
            min-height: 70px;
            border-radius: 10px;
            border: 1px solid rgba(15,45,50,0.14);
            background: #f4f8fb;
            color: #0f2d32;
            padding: 10px;
            resize: vertical;
            font-family: inherit;
          }
          #${FEEDBACK_CONTAINER_ID} textarea::placeholder {
            color: rgba(15,45,50,0.55);
          }
          #${FEEDBACK_CONTAINER_ID} .vf-convo-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
          }
          #${FEEDBACK_CONTAINER_ID} .vf-convo-actions button {
            border-radius: 10px;
            border: 1px solid rgba(15,45,50,0.16);
            background: #ffffff;
            color: #0f2d32;
            padding: 8px 14px;
            cursor: pointer;
            font-weight: 600;
          }
          #${FEEDBACK_CONTAINER_ID} .vf-convo-actions .vf-submit {
            background: #48c6ea;
            color: #0b2930;
            border-color: transparent;
          }
          #${FEEDBACK_CONTAINER_ID} .vf-convo-actions button:disabled {
            opacity: 0.6;
            cursor: default;
          }
          #${FEEDBACK_CONTAINER_ID} .vf-convo-thanks {
            margin: 0;
            font-weight: 600;
            color: #0b2930;
            font-size: 14px;
          }
          .vf-convo-panel.vf-convo-success {
            animation: vfConvoSuccess 200ms ease;
          }
          @keyframes vfConvoSuccess {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
          }
        `;
        shadow.appendChild(style);
      };

      const insertAfter = (target, node) => {
        const parent = target?.parentNode;
        if (!parent) return;
        parent.insertBefore(node, target.nextSibling);
      };

      const buildFeedback = () => {
        // CTA lives in footer links, panel lives in footer content for full width.
        const cta = document.createElement("button");
        cta.className = "vf-convo-cta";
        cta.type = "button";
        cta.textContent = CTA_TEXT;

        const panel = document.createElement("div");
        panel.className = "vf-convo-panel";
        panel.setAttribute("role", "group");
        panel.setAttribute("aria-label", PANEL_TITLE);
        panel.innerHTML = `
          <p class="vf-convo-header">${PANEL_TITLE}</p>
          <div class="vf-convo-ratings" role="radiogroup" aria-label="${PANEL_TITLE}">
            ${[1,2,3,4,5].map((n) => `<button type="button" class="vf-convo-rating-btn" data-rating="${n}" aria-label="${n}">${n}</button>`).join("")}
          </div>
          <label for="vf-convo-comment">${COMMENT_LABEL}</label>
          <textarea id="vf-convo-comment" placeholder="${COMMENT_LABEL}"></textarea>
          <div class="vf-convo-actions">
            <button type="button" class="vf-cancel">Sulje</button>
            <button type="button" class="vf-submit" disabled>Lähetä</button>
          </div>
        `;

        const wrapper = document.createElement("div");
        wrapper.id = FEEDBACK_CONTAINER_ID;
        wrapper.style.position = "relative";
        wrapper.style.width = "100%";
        wrapper.appendChild(panel);

        const ratingButtons = Array.from(panel.querySelectorAll(".vf-convo-rating-btn"));
        const comment = panel.querySelector("textarea");
        const cancelBtn = panel.querySelector(".vf-cancel");
        const submitBtn = panel.querySelector(".vf-submit");

        let rating = null;
        let locked = false;

        const open = () => {
          wrapper.classList.add("open");
          panel.scrollIntoView({ behavior: "smooth", block: "nearest" });
          comment.focus();
        };

        const close = () => {
          wrapper.classList.remove("open");
        };

        const lockUI = () => {
          locked = true;
          ratingButtons.forEach((btn) => (btn.disabled = true));
          comment.disabled = true;
          submitBtn.disabled = true;
          cancelBtn.disabled = true;
          cta.disabled = true;
          panel.style.opacity = "0";
          setTimeout(() => {
            panel.innerHTML = `<p class="vf-convo-thanks">Kiitos palautteesta!</p>`;
            panel.classList.add("vf-convo-success");
            panel.style.opacity = "1";
            setTimeout(() => {
              wrapper.classList.remove("open");
              panel.classList.remove("vf-convo-success");
              panel.style.opacity = "";
            }, 3000);
          }, 120);
        };

        const updateSubmitState = () => {
          submitBtn.disabled = !rating || locked;
        };

        ratingButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            if (locked) return;
            rating = Number(btn.dataset.rating);
            ratingButtons.forEach((b) => b.classList.toggle("selected", b === btn));
            updateSubmitState();
          });
        });

        cta.addEventListener("click", open);
        cancelBtn.addEventListener("click", close);

        submitBtn.addEventListener("click", () => {
          if (!rating || locked) return;
          const payload = { rating, comment: comment.value.trim() || undefined };
          sendWidgetEvent("feedback_submitted", payload);
          lockUI();
        });

        return { cta, wrapper };
      };

      const mountFeedback = () => {
        const shadow = getChatShadowRoot();
        if (!shadow) {
          setTimeout(mountFeedback, INJECTION_DELAY_MS);
          return;
        }
        ensureStyles(shadow);
        const existing = shadow.getElementById(FEEDBACK_CONTAINER_ID);
        if (existing) return;

        const links = shadow.querySelector(".vfrc-footer__links");
        const footerContent = shadow.querySelector(".vfrc-footer__content");
        const composer = shadow.querySelector(".vfrc-input-container");

        if (!composer) {
          setTimeout(mountFeedback, INJECTION_DELAY_MS);
          return;
        }

        const { cta, wrapper } = buildFeedback();

        if (links) {
          links.appendChild(cta);
        } else {
          insertAfter(composer, cta);
        }

        if (footerContent) {
          footerContent.appendChild(wrapper);
        } else {
          insertAfter(composer, wrapper);
        }
      };

      mountFeedback();
    </script>

  </body>
</html>
